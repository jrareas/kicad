.subckt 18650 Aneg Apos COC
C0 CoC 0 {(1.1-TC)*As}
DL 0 CoC MD1
B1 0 CoC I=Ah*CF(I(Bemf)/Ah)
Bemf N002 Aneg V=VF(V(SoC))

S1 N001 N002 SoC 0 SR
R2 Apos N001 {0.1*Rs}
C2 Aneg N001 {10u*As}
R3 SoC CoC 1k
C3 SoC 0 1m
C1 N003 N001 {TC*As}
S2 Aneg N003 SoC 0 SC
.model MD1 D(Ron=1m Vrev=1)
.param Ah=2.4 Rs=135m TC=3m TR=3 As={Ah*3600}
.model SR SW(Ron={0.9*Rs} Roff={1.3*Rs} Vt=0.2 Vh=-0.2)
.model SC SW(Ron={TR*Rs} Roff={100*TR*Rs} Vt=0.2 Vh=-0.1)
.func CF (x)  table(x,    
+  -10,  -30,     ;-10C
+  -2,    -2.9,    ;-2C 
+  -1.5, -1.9,    ;-1.5C
+  -1,    -1.14,  ;-1C   
+  -0.5, -0.55,  ;-0.5C
+  -0.2, -0.2,    ;-0.2C  
+   
+   0,     0,; self-disch.
+
+   0.5,  0.47,  ;0.5C
+   1,     0.8,    ;2C
+   4,     2,       ;4C
+   10,   5)       ;10C
.func VF(x) table(x,
+  0,         0,       ;  0%
+  0.02,    1.8,    ;  2%
+  0.045,  3.22,  ;  4,5%
+  0.055,  3.39,  ;  5,5%
+  0.067,  3.52,  ;  6,7%
+  0.078,  3.58,  ;  7,8%
+  0.09,    3.61,  ;  9%
+  0.11,    3.64,  ;11%
+  0.14,    3.67,  ;14%
+  0.18,    3.69,  ;18%
+
+  0.40,    3.75,  ;40%
+  0.50,    3.78,  ;50%
+  0.55,    3.80,  ;55%
+  0.60,    3.83,  ;60%
+  0.70,    3.90,  ;70%
+  
+  0.96,    4.13,  ;96%
+  0.97,    4.14,  ;97%
+  0.995,  4.17,  ;99,5%
+  1,         4.2)    ;100%
.ends 18650
